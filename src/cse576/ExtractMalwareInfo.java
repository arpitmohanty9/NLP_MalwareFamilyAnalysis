package cse576;

import java.io.File;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Set;

public class ExtractMalwareInfo {

	public static void main(String[] args) throws Exception {
		if (args.length == 0) {
			System.out.println("Pass an Malware Name as cmd line.");
			return;
		}

		ClassLoader loader = ExtractMalwareInfo.class.getClassLoader();
		String path = loader.getResource("cse576/ExtractMalwareInfo.class").toString();
		path = path.substring(path.indexOf(":/") + 2);
		path = path.substring(0, path.indexOf("/cse576"));
		if (path.indexOf("/bin") != -1) {
			path = path.substring(0, path.indexOf("/bin"));
		}
		path = path.replace("/", "\\");
		path = path.replace("%20", " ");
		System.out.println(path);

		SimpleDateFormat dateForm = new SimpleDateFormat("dd MMM, yyyy");
		for (String malware : args) {
			File file = new File(path + "\\data\\" + malware + ".csv");
			if (!file.exists()) {
				System.out.println("Run the scraper first for " + malware);
				continue;
			}

			String[] records = Utility.readCSV(path, malware);

			for (String record : records) {
				HashMap<String, String[]> result1 = Utility.runCommand("python " + path + "\\python\\1.py \"" + record +"\"");
				if (result1 != null) {
					for (String str : result1.get("OUTPUT")) {
						System.out.println(str);
					}
				}
				HashMap<String, Object> result = ExtractDateCVEfromReport.ExtractDateCVE(record);
				Date foundDate = (Date) result.get("DATE");
				Set<?> listCVETmp = null;
				String[] listCVE = null;
				Object cve = result.get("CVE");
				if (cve instanceof ArrayList<?>) {
					ArrayList<?> temp = (ArrayList<?>) cve;
					listCVETmp = new HashSet<>(temp);
				}

				if (listCVETmp != null && listCVETmp.size() > 0) {
					listCVE = listCVETmp.toArray(new String[listCVETmp.size()]);
				}

				System.out.println("Malware Name:    " + malware);
				System.out.println("Date Found:      " + dateForm.format(foundDate));
				System.out.println("CVE Exploited:   " + Arrays.toString(listCVE));
				System.out.println("----------------------------------------------------------------------");
			}
		}

		System.exit(0);
	}
}
