import pydot

class FamilyTree:
    def __init__(self):
        self.graph = pydot.Dot(graph_type='graph')
        pass

    def CreateTree(self, data, outputfilename):

        num = len(data.keys())

        #Add node to the graphs
        nodedict = {}
        for i in range(1, num+1):
            obj = data[str(i)]
            name = 'Name-' + str(obj.MalwareName) + '\n' + \
                   'Target-' + str(obj.Target) + '\n' + \
                   'Tools-' + str(obj.Tools) + '\n' + \
                   'CVE-' + str(obj.ExploitedCVE) + '\n' + \
                   'Date Found-' + str(obj.DateFound)
            node = pydot.Node(name, style="filled", fillcolor="green")
            self.graph.add_node(node)
            nodedict[i] = node
            pass

        #Add Edges to the graph
        for i in range(1, num + 1):
            for j in range(1, num + 1):
                id_I = data[str(i)].id
                id_J = data[str(j)].id
                pid_I = data[str(i)].pid
                pid_J = data[str(j)].pid

                if id_I == pid_J:
                    self.graph.add_edge(pydot.Edge(nodedict[i], nodedict[j]))



        try:
            self.graph.write_png(outputfilename)
        except:
            import os
            import sys

            if sys.platform == 'win32':
                pydotpath = pydot.__file__
                pydotpath = pydotpath.split('\\')[:-3]
                pydotpath.append('Library')
                pydotpath.append('bin')
                pydotpath.append('graphviz')
                dotPath = '\\'.join(pydotpath)
            else:
                dotPath = ''
            os.environ["PATH"] += os.pathsep + dotPath

            self.graph.write(outputfilename, format="png")
        pass



